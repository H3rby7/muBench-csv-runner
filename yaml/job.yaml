apiVersion: batch/v1
kind: Job
metadata:
  name: cloud-ee-benchmarking
  labels:
    benchmark: input
spec:
  template:
    spec:
      serviceAccountName: benchmark-sa
      initContainers:
      - name: builder
        image: lujoka/mub-k8s-templater:latest
        imagePullPolicy: Always
        command: ["/app/entrypoint.sh", "--config-file", "/builder-config/K8sParameters.json", "--log-level", "DEBUG", "-y"]
        volumeMounts:
        - name: dataset
          mountPath: "/dataset"
          readOnly: true
        - name: k8s-yaml
          mountPath: "/k8s-yaml"
          readOnly: false
      containers:
      - name: runner
        image: lujoka/mub-csv-runner:latest
        imagePullPolicy: Always
        # The actual command
        # command: ["/app/entrypoint.sh", "--config-file", "/runner-config/RunnerParameters.json"]
        # Sleep command so we can exec into the container and see all file paths work
        command: ["/bin/bash", "-c", "--"]
        args: [ "while true; do sleep 30; done;" ]
        volumeMounts:
        - name: dataset
          mountPath: "/dataset"
          readOnly: true
        - name: k8s-yaml
          mountPath: "/k8s-yaml"
          readOnly: true
        - name: runner-params
          mountPath: "/runner-config"
        - name: k8s-params
          mountPath: "/builder-config"
          readOnly: true
        - name: internal-services
          mountPath: "/InternalServiceFunctions"
          readOnly: true
        - name: result
          mountPath: "/result"
          readOnly: false
      restartPolicy: Never
      volumes:
        - name: dataset
          persistentVolumeClaim:
            claimName: dataset
        - name: result
          persistentVolumeClaim:
            claimName: result
        - name: k8s-yaml
          emptyDir: {}
        - name: runner-params
          configMap:
            name: csv-runner-params
        - name: k8s-params
          configMap:
            name: k8s-params
        - name: internal-services
          configMap:
            name: internal-services
  backoffLimit: 1
